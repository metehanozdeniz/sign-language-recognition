{% extends 'base.html' %}
{% block content %}
<h1>Create Dataset for Letter Level</h1>
<div id="alert-area"></div>
<div class="row">
    <!-- Left column: Camera Stream -->
    <div class="col-md-6">
        <p>Camera:</p>
        <img src="{{ url_for('video_feed') }}" class="img-fluid" alt="Camera Stream">
    </div>
    <!-- Right column: input, button and chart -->
    <div class="col-md-6">
        <form id="datasetForm">
            <div class="mb-3">
                <label for="dataset_label" class="form-label">Label</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="dataset_label" name="dataset_label" placeholder="Label">
                    <button type="submit" class="btn btn-outline-success">
                        <span id="spinner" class="spinner-grow spinner-grow-sm sr-only" , role="status" ,
                            aria-hidden="true" style="display: none;"></span>
                        <span class="sr-only">Save</span>
                    </button>
                </div>
            </div>
        </form>
        <!-- Grafik için Canvas -->
        <div class="row mt-4">
            <div class="col-12">
                <canvas id="labelChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- DataTable için kapsayıcı -->
<div class="row mt-4">
    <div class="col-12">
        <table id="datatable" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>Label</th>
                    <th>Landmark 1</th>
                    <th>Landmark 2</th>
                    <th>Landmark 3</th>
                    <th>Landmark 4</th>
                    <th>Landmark 5</th>
                    <th>Landmark 6</th>
                    <th>Landmark 7</th>
                    <th>Landmark 8</th>
                    <th>Landmark 9</th>
                    <th>Landmark 10</th>
                    <th>Landmark 11</th>
                    <th>Landmark 12</th>
                    <th>Landmark 13</th>
                    <th>Landmark 14</th>
                    <th>Landmark 15</th>
                    <th>Landmark 16</th>
                    <th>Landmark 17</th>
                    <th>Landmark 18</th>
                    <th>Landmark 19</th>
                    <th>Landmark 20</th>
                    <th>Landmark 21</th>
                    <th>Landmark 22</th>
                    <th>Landmark 23</th>
                    <th>Landmark 24</th>
                    <th>Landmark 25</th>
                    <th>Landmark 26</th>
                    <th>Landmark 27</th>
                    <th>Landmark 28</th>
                    <th>Landmark 29</th>
                    <th>Landmark 30</th>
                    <th>Landmark 31</th>
                    <th>Landmark 32</th>
                    <th>Landmark 33</th>
                    <th>Landmark 34</th>
                    <th>Landmark 35</th>
                    <th>Landmark 36</th>
                    <th>Landmark 37</th>
                    <th>Landmark 38</th>
                    <th>Landmark 39</th>
                    <th>Landmark 40</th>
                    <th>Landmark 41</th>
                    <th>Landmark 42</th>
                </tr>
            </thead>
            <!-- <tbody>
                <tr>
                    <td></td>
                </tr>
            </tbody> -->
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery ve DataTables kütüphaneleri -->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.2/js/dataTables.buttons.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.bootstrap5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.colVis.min.js"></script>
<script src="{{ url_for('static', filename='js/chartjs.min.js') }}"></script>
<script>
    var table;

    $(document).ready(function () {
        // DataTable'ı ajax üzerinden verileri alacak şekilde başlatıyoruz.
        table = $('#datatable').DataTable({
            ajax: {
                url: "{{ url_for('get_db_data') }}",
                dataType: 'json',
                dataSrc: ''
            },
            scrollX: true,
            autoWidth: false,
            responsive: false,
            scrollCollapse: true,
            layout: {
                topStart: {
                    buttons: ['copy', 'excel', 'pdf', 'print', 'csv', 'colvis']
                }
            }
        });

        // Form gönderiminin AJAX ile yapılması.
        $('#datasetForm').on('submit', function (e) {
            e.preventDefault();  // Sayfanın yeniden yüklenmesini engelle
            var label = $('#dataset_label').val().trim();
            if (label === "") {
                $('#alert-area').html(
                    '<div class="alert alert-warning alert-dismissible fade show" role="alert">' +
                    'Label can not be empty!' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                    '</div>'
                );
                return;
            }

            $.ajax({
                url: "{{ url_for('create_dataset') }}",
                type: "POST",
                data: { dataset_label: label },
                // beforeSend: function () {
                //     // AJAX isteği başlamadan spinner'ı göster
                //     $('#spinner').show();
                // },
                // complete: function () {
                //     // AJAX isteği tamamlandığında spinner'ı gizle
                //     $('#spinner').hide();
                // },
                success: function (response) {
                    // Eğer sunucudan hata mesajı gelirse (örneğin input boşsa), alert gösterelim.
                    if (response.status && response.status === 'error') {
                        $('#alert-area').html(
                            '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                            response.message +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                            '</div>'
                        );
                    } else {
                        $('#alert-area').html(
                            '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                            'Data saved successfully.' +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                            '</div>'
                        );
                        // Yeni satır ekleme işlemi yerine, sadece tablonun verilerini yeniden çekelim:
                        table.ajax.reload(null, false); // false: sayfa numarasını korur
                        $('#datasetForm')[0].reset();
                        updateChart();  // Update chart after adding new data
                    }
                },
                error: function (xhr, status, error) {
                    $('#alert-area').html(
                        '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                        'Error: ' + error +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                        '</div>'
                    );
                }
            });
        });

        // First chart
        updateChart();
    });

    // Create and update the chart for label frequency
    function updateChart() {
        $.ajax({
            url: "{{ url_for('get_db_data') }}",
            type: "GET",
            dataType: "json",
            beforeSend: function () {
                // AJAX isteği başlamadan spinner'ı göster, butonu devre dışı bırak ve input alanını readonly yap
                $('#submitBtn').prop('disabled', true);
                $('#spinner').show();
                $('#dataset_label').prop('readonly', true);
            },
            complete: function () {
                // AJAX isteği tamamlandığında spinner'ı gizle, butonu aktif et ve input alanının readonly özelliğini devre dışı bırak
                $('#spinner').hide();
                $('#submitBtn').prop('disabled', false);
                $('#dataset_label').prop('readonly', false);
            },
            success: function (data) {
                var frequency = {};
                data.forEach(function (row) {
                    if (row.length > 0) {
                        var label = row[0];
                        frequency[label] = (frequency[label] || 0) + 1;
                    }
                });
                var labels = Object.keys(frequency).sort();
                var counts = labels.map(function (lbl) { return frequency[lbl]; });

                console.log("Frequency:", frequency);

                // if chart exists, destroy it and create a new one
                if (window.labelChart instanceof Chart) {
                    console.log("Destroying previous chart...");
                    window.labelChart.destroy();
                }

                var ctx = document.getElementById('labelChart').getContext('2d');
                window.labelChart = new Chart(ctx, {
                    type: 'bar',  // maybe 'line' or 'pie' etc.
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Label Frequency',
                            data: counts,
                            backgroundColor: 'rgba(96, 191, 151, 0.6)',
                            borderColor: 'rgba(0, 255, 0, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Label Frequency in CSV File' }
                        },
                        scales: {gf
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255,255,255,0.2)' }
                            },
                            x: {
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255,255,255,0.2)' }
                            }
                        }
                    }
                });
            }
        });
    }
</script>
{% endblock %}

<!--
    TODO: Veritabanındaki verilerin label frekansları client tarafında hesaplandığı için delay'a sebebiyet veriyor. 
    Bunu sunucu tarafında yaparak optimize etmek gerekiyor.
-->